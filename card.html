<!doctype html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <title>Card</title>
  </head>
  <body id="app">
    
    <span class="badge bg-primary text-wrap" style="width: 6rem;">{{type}}</span>
    <h1>{{name}}</h1>

    <div class="accordion" id="accordionExample">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            説明
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            {{explanation}}
          </div>
        </div>
      </div>
    </div>

    <div id="associations">
      <div v-for="item in associations" class="btn-group">
          <button type="button" class="btn btn-primary" v-on:click="openAssociates(item)">
            {{item.associate}}<span class="badge bg-secondary">{{item.numAssoc}}</span>
          </button>
          <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" v-bind:href="'editassoc.html?card=' + id + '&type=' + item.associate">関連先を追加</a></li>
            <li><a class="dropdown-item" v-on:click="deleteAssociates(item)" href="#">関連をクリア</a></li>
          </ul>
        </div>
      <a v-bind:href="'editassoc.html?card=' + id">
        <button type="button" class="btn btn-outline-primary">
          新しい関連を追加
        </button>  
      </a>
    </div>

    <hr/>
    <a href="list.html">
      <button type="button" class="btn btn-secondary">一覧へ</button>
    </a>

    <hr/>
    <div>
      <a v-bind:href="'editcard.html?card=' + id">
        <button type="button" class="btn btn-outline-primary">編集</button>
      </a>
      <button type="button" class="btn btn-outline-danger" v-on:click="deleteCard">削除</button>
    </div>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->
    <script src="https://unpkg.com/vue@next"></script>
    <script>
    var cards = JSON.parse(localStorage.getItem("cards"));
    var associates = JSON.parse(localStorage.getItem("associates"));

    var param = new URL(location).searchParams;
    console.log(param);
    var cardId = param.get("card");

    var links = associates.filter(a => a.src == cardId || a.dst == cardId)
                  .map(a => {
                    var card = a.src == cardId ? cards[a.dst] : cards[a.src];
                    var key = a.src == cardId && a.name ? a.name : card.type;
                    return {
                      "associate": key,
                      "card": card
                    };
                  });

    var mapping = new Map();
    links.forEach(a => {
      const assoc = mapping.get(a.associate);
      if (assoc) {
        Object.assign(assoc, {"associate": a.associate, "cardIds": [...assoc.cardIds, a.card.id], "numAssoc": assoc.numAssoc + 1});
      } else {
        mapping.set(a.associate, {"associate": a.associate, "cardIds": [a.card.id], "numAssoc": 1})
      }
    });

    Vue.createApp({
      data: function() {
        return Object.assign(cards[cardId], {"associations": mapping.values(), "cardId": cardId})
      },
      methods: {
        deleteCard() {
          const msg1 = "削除してよろしいですか？他の単語との関連も全て消えます";
          const msg2 = "本当に本当によろしいですか？";
          if (confirm(msg1) && confirm(msg2)) {
            var newLinks = associates.filter(a => a.src != cardId && a.dst != cardId);
            delete cards[cardId];
            localStorage.setItem("cards", JSON.stringify(cards));
            localStorage.setItem("associates", JSON.stringify(newLinks));
            alert("削除しました");
            location = "list.html";
          }
        },
        openAssociates(item) {
          if(item.numAssoc > 1) {
            location = "list.html?cards=" + item.cardIds.join(',');
          } else {
            location = "card.html?card=" + item.cardIds[0];
          }
        },
        deleteAssociates(item) {
          const msg1 = `「${item.associate}」の関連をクリアしてよろしいですか？\n ${item.numAssoc}個の関連がクリアされます（単語自体は消えません）`;
          const msg2 = "本当に本当によろしいですか？";
          if (confirm(msg1) && confirm(msg2)) {
            var newLinks = associates.filter(
              a => !(a.src == cardId && item.cardIds.includes(a.dst) ||
                     a.dst == cardId && item.cardIds.includes(a.src)));
            localStorage.setItem("associates", JSON.stringify(newLinks));
            alert("削除しました");
            location.reload();
          }
        }
      }
    }).mount('#app');
    </script>
  </body>
</html>